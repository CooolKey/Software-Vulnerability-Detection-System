from flask import render_template, Flask, flash, redirect, url_for, request
from forms.file_form import FileForm
from forms.result_form import ResultForm
from function.extract import extract
from function.json2txt import Json2Txt
from machine_learning.predict import predict
# import requests
import os

app = Flask(__name__)
app.secret_key = '2021'

upload_dir = os.path.join(
    app.instance_path, 'upload' 
)
if not os.path.exists(upload_dir):
    os.makedirs(upload_dir, mode=0o755)

result_json_dir = os.path.join(
    app.instance_path, 'result/unknow' 
)
if not os.path.exists(result_json_dir):
    os.makedirs(result_json_dir, mode=0o755)

result_json_dir2 = 'instance/result/unknow' 
txt_dir2 = 'source/unknow' 

txt_dir = os.path.join(
    app.root_path, 'source/unknow' 
)
if not os.path.exists(txt_dir):
    os.makedirs(txt_dir, mode=0o755)


@app.route('/', methods=['GET', 'POST'])
def index():
    form = FileForm()
    r_form= ResultForm()
    if form.validate_on_submit():

        f = form.file_path.data
        fp = os.path.join(upload_dir, f.filename)
        f.save(fp)
        flash('upload ok')

        flash('analysis')
        # extract(fp,result_json_dir)
        flash('analysis ok')

        flash('2txt')
        obj = Json2Txt(result_json_dir2, txt_dir2)
        r_form.file_size, r_form.file_type, r_form.test_env, r_form.file_sha1, r_form.file_sha256, r_form.file_sha512, r_form.file_md5 = obj.json2txt()
        flash('txt ok')

        flash('predict')
        prediction = predict(txt_dir)
        flash('ok')

        if prediction == 1:
            r_form.result1 = "Congratulations!"
            r_form.result2 = "This is most likely a normal software :)"
        else:
            r_form.result1 = "Sorry~"
            r_form.result2 = "This is most likely a malware :("

        return render_template('result.html', form=r_form)
    return render_template('index.html', form=form)

@app.route('/result', methods=['GET', 'POST'])
def result():
    form = ResultForm()
    form = request.form
    return render_template('result.html', form=form)

if __name__ == '__main__':
    app.run()